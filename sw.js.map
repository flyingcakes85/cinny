{"version":3,"file":"sw.mjs","sources":["../src/sw.ts"],"sourcesContent":["/// <reference lib=\"WebWorker\" />\n\nexport type {};\ndeclare const self: ServiceWorkerGlobalScope;\n\nasync function askForAccessToken(client: Client): Promise<string | undefined> {\n  return new Promise((resolve) => {\n    const responseKey = Math.random().toString(36);\n    const listener = (event: ExtendableMessageEvent) => {\n      if (event.data.responseKey !== responseKey) return;\n      resolve(event.data.token);\n      self.removeEventListener('message', listener);\n    };\n    self.addEventListener('message', listener);\n    client.postMessage({ responseKey, type: 'token' });\n  });\n}\n\nfunction fetchConfig(token?: string): RequestInit | undefined {\n  if (!token) return undefined;\n\n  return {\n    headers: {\n      Authorization: `Bearer ${token}`,\n    },\n    cache: 'default',\n  };\n}\n\nself.addEventListener('activate', (event: ExtendableEvent) => {\n  event.waitUntil(clients.claim());\n});\n\nself.addEventListener('fetch', (event: FetchEvent) => {\n  const { url, method } = event.request;\n  if (method !== 'GET') return;\n  if (\n    !url.includes('/_matrix/client/v1/media/download') &&\n    !url.includes('/_matrix/client/v1/media/thumbnail')\n  ) {\n    return;\n  }\n  event.respondWith(\n    (async (): Promise<Response> => {\n      const client = await self.clients.get(event.clientId);\n      let token: string | undefined;\n      if (client) token = await askForAccessToken(client);\n\n      return fetch(url, fetchConfig(token));\n    })()\n  );\n});\n"],"names":["askForAccessToken","client","resolve","responseKey","listener","event","fetchConfig","token","url","method"],"mappings":"AAKA,eAAeA,EAAkBC,EAA6C,CACrE,OAAA,IAAI,QAASC,GAAY,CAC9B,MAAMC,EAAc,KAAK,OAAO,EAAE,SAAS,EAAE,EACvCC,EAAYC,GAAkC,CAC9CA,EAAM,KAAK,cAAgBF,IACvBD,EAAAG,EAAM,KAAK,KAAK,EACnB,KAAA,oBAAoB,UAAWD,CAAQ,EAC9C,EACK,KAAA,iBAAiB,UAAWA,CAAQ,EACzCH,EAAO,YAAY,CAAE,YAAAE,EAAa,KAAM,QAAS,CAAA,CAClD,CACH,CAEA,SAASG,EAAYC,EAAyC,CACxD,GAACA,EAEE,MAAA,CACL,QAAS,CACP,cAAe,UAAUA,CAAK,EAChC,EACA,MAAO,SACT,CACF,CAEA,KAAK,iBAAiB,WAAaF,GAA2B,CACtDA,EAAA,UAAU,QAAQ,OAAO,CACjC,CAAC,EAED,KAAK,iBAAiB,QAAUA,GAAsB,CACpD,KAAM,CAAE,IAAAG,EAAK,OAAAC,CAAO,EAAIJ,EAAM,QAC1BI,IAAW,QAEb,CAACD,EAAI,SAAS,mCAAmC,GACjD,CAACA,EAAI,SAAS,oCAAoC,GAI9CH,EAAA,aACH,SAA+B,CAC9B,MAAMJ,EAAS,MAAM,KAAK,QAAQ,IAAII,EAAM,QAAQ,EAChD,IAAAE,EACJ,OAAIN,IAAQM,EAAQ,MAAMP,EAAkBC,CAAM,GAE3C,MAAMO,EAAKF,EAAYC,CAAK,CAAC,CACnC,GAAA,CACL,EACF,CAAC"}